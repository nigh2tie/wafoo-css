<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>wafoo-css | A11y テスト</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <meta name="robots" content="noindex,nofollow" />
    <link rel="stylesheet" href="../dist/wafoo.css" />
    <script src="./theme.js"></script>
    <script src="./ui.js"></script>
    <style>
      body {
        margin: 0;
      }
      .res {
        font-size: 14px;
        color: #555;
      }
      .res .ok {
        color: #2e7d32;
      }
      .res .ng {
        color: #b00020;
      }
    </style>
  </head>
  <body>
    <a href="#main" class="wf-sr-only">メインコンテンツへスキップ</a>
    <header class="wf-header-noren" role="banner">
      <div class="wf-container" style="padding: 0"><h1>A11y テスト</h1></div>
    </header>
    <main id="main" class="wf-container" role="main">
      <section class="wf-mb-6">
        <h2>Dropdown</h2>
        <div class="wf-dropdown" id="dd">
          <button
            id="ddbtn"
            class="wf-dropdown__toggle"
            aria-expanded="false"
            aria-controls="ddmenu"
          >
            メニュー ▾
          </button>
          <ul id="ddmenu" class="wf-dropdown__menu" hidden>
            <li><a class="wf-dropdown__item" href="#">Action</a></li>
            <li><a class="wf-dropdown__item" href="#">Another</a></li>
            <li><a class="wf-dropdown__item" href="#">More</a></li>
          </ul>
        </div>
        <div class="res" id="dd-res"></div>
        <button class="wf-btn wf-btn-outline" id="dd-run">チェック</button>
      </section>

      <section class="wf-mb-6">
        <h2>Popover</h2>
        <button id="pv-btn" class="wf-btn" aria-controls="pv1" aria-expanded="false">
          ポップオーバー
        </button>
        <div id="pv1" class="wf-popover" role="dialog" hidden>
          <div class="wf-popover__header" id="pv1-title">タイトル</div>
          <div class="wf-popover__body"><button class="wf-btn wf-btn-sm">内部ボタン</button></div>
        </div>
        <div class="res" id="pv-res"></div>
        <button class="wf-btn wf-btn-outline" id="pv-run">チェック</button>
      </section>

      <section class="wf-mb-6">
        <h2>Modal</h2>
        <button id="md-open" class="wf-btn wf-btn-primary">開く</button>
        <div id="md-ov" class="wf-modal-overlay" aria-hidden="true">
          <div class="wf-modal wf-modal-sm">
            <div class="wf-modal__header">
              <h4 class="wf-modal__title" style="margin: 0">モーダル</h4>
              <button id="md-close" class="wf-modal__close" aria-label="閉じる">✕</button>
            </div>
            <div class="wf-modal__body">
              <button id="first" class="wf-btn wf-btn-sm">最初</button>
              <button id="last" class="wf-btn wf-btn-sm">最後</button>
            </div>
            <div class="wf-modal__footer">
              <button class="wf-btn wf-btn-outline" id="md-ok">OK</button>
            </div>
          </div>
        </div>
        <div class="res" id="md-res"></div>
        <button class="wf-btn wf-btn-outline" id="md-run">チェック</button>
      </section>
    </main>
    <script>
      function pass(el, msg) {
        el.innerHTML += `<div class="ok">✓ ${msg}</div>`;
      }
      function fail(el, msg) {
        el.innerHTML += `<div class="ng">✕ ${msg}</div>`;
      }

      window.addEventListener("DOMContentLoaded", () => {
        // Dropdown
        if (window.WFUI) {
          WFUI.dropdown(document.getElementById("dd"));
        }
        document.getElementById("dd-run").addEventListener("click", () => {
          const out = document.getElementById("dd-res");
          out.innerHTML = "";
          const btn = document.getElementById("ddbtn");
          const menu = document.getElementById("ddmenu");
          // roles
          if (menu.getAttribute("role") === "menu") pass(out, "menu に role=menu");
          else fail(out, "menu に role=menu が必要");
          const items = Array.from(menu.querySelectorAll(".wf-dropdown__item"));
          if (items.every(a => a.getAttribute("role") === "menuitem"))
            pass(out, "すべての項目に role=menuitem");
          else fail(out, "role=menuitem 不足");
          // roving tabindex by key
          btn.dispatchEvent(new KeyboardEvent("keydown", { key: "Enter", bubbles: true }));
          btn.dispatchEvent(new KeyboardEvent("keydown", { key: "ArrowDown", bubbles: true }));
          if (document.activeElement === items[0]) pass(out, "ArrowDown で最初の項目にフォーカス");
          else fail(out, "ArrowDown フォーカス移動失敗");
        });

        // Popover
        if (window.WFUI) {
          WFUI.popover(document.getElementById("pv-btn"), document.getElementById("pv1"));
        }
        document.getElementById("pv-run").addEventListener("click", () => {
          const out = document.getElementById("pv-res");
          out.innerHTML = "";
          const btn = document.getElementById("pv-btn");
          const pv = document.getElementById("pv1");
          btn.click();
          if (pv.getAttribute("role") === "dialog") pass(out, "popover に role=dialog");
          else fail(out, "popover role=dialog");
          if (pv.hasAttribute("aria-labelledby")) pass(out, "aria-labelledby 設定");
          else fail(out, "aria-labelledby 不足");
          const first = pv.querySelector("button");
          setTimeout(() => {
            if (document.activeElement === first) pass(out, "開いたとき内部ボタンに初期フォーカス");
            else fail(out, "初期フォーカスが移動しない");
          }, 50);
        });

        // Modal
        let api = null;
        if (window.WFUI) {
          api = WFUI.modal(document.getElementById("md-open"), document.getElementById("md-ov"), {
            closeSelectors: ["#md-close", "#md-ok"]
          });
        }
        document.getElementById("md-run").addEventListener("click", () => {
          const out = document.getElementById("md-res");
          out.innerHTML = "";
          const ov = document.getElementById("md-ov");
          document.getElementById("md-open").click();
          const dlg = ov.querySelector(".wf-modal");
          if (
            dlg &&
            dlg.getAttribute("role") === "dialog" &&
            dlg.getAttribute("aria-modal") === "true"
          )
            pass(out, "モーダルに role=dialog, aria-modal=true");
          else fail(out, "モーダルのロール/属性不足");
          // Determine first focusable inside overlay (dialog範囲の先頭)
          function focusablesIn(root) {
            return Array.from(
              root.querySelectorAll(
                'a[href], button, input, select, textarea, [tabindex]:not([tabindex="-1"])'
              )
            ).filter(el => !el.hasAttribute("disabled"));
          }
          const f = focusablesIn(ov);
          const expectedFirst = f[0];
          const last = document.getElementById("last");
          last.focus();
          // dispatch on document to ensure capture listeners also receive the event
          document.dispatchEvent(new KeyboardEvent("keydown", { key: "Tab", bubbles: true }));
          setTimeout(() => {
            if (document.activeElement === expectedFirst) pass(out, "Tab 循環で末尾→先頭へ");
            else fail(out, "Tab 循環が機能しない");
          }, 30);
        });
      });
    </script>
  </body>
</html>
